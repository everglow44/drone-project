import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from io import BytesIO
import base64


class FastDronePacking:
    import numpy as np
    import matplotlib.pyplot as plt

    from mpl_toolkits.mplot3d import Axes3D

    class FastDronePacking:
        def __init__(self):
            # æ— äººæœºå‚æ•° (é•¿Ã—å®½Ã—é«˜ mm)
            self.drones = {
                'cargo': {'size': [1105, 1265, 975], 'color': 'red', 'name': 'FlyCart 100'},
                'scout': {'size': [221, 96.3, 90.3], 'color': 'green', 'name': 'Mavic 3E'}
            }

            # é›†è£…ç®±å‚æ•° (é•¿Ã—å®½Ã—é«˜ mm)
            self.container = {'size': [6058, 2591, 2438]}

            # å­˜å‚¨æ”¾ç½®çš„æ— äººæœº
            self.placed_drones = []

            # è®°å½•å¯ç”¨ä½ç½®
            self.available_positions = [(0, 0, 0)]
            self.disaster_mapping = {
                'cargo': 'ç‰©èµ„æŠ•é€ç±»ç¾æƒ…ï¼ˆåœ°éœ‡ã€æ´ªæ°´ç­‰éœ€è¦å¤§é‡ç‰©èµ„é…é€ï¼‰',
                'scout': 'ä¾¦å¯Ÿç›‘æµ‹ç±»ç¾æƒ…ï¼ˆæ£®æ—ç«ç¾ã€åœ°è´¨ç¾å®³ç­‰éœ€è¦æŒç»­ç›‘æ§ï¼‰'
            }

        def can_place_drone(self, position, drone_size):
            """å¿«é€Ÿæ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®æ— äººæœº"""
            x, y, z = position
            l, w, h = drone_size

            # æ£€æŸ¥æ˜¯å¦è¶…å‡ºé›†è£…ç®±è¾¹ç•Œ
            if (x + l > self.container['size'][0] or
                    y + w > self.container['size'][1] or
                    z + h > self.container['size'][2]):
                return False

            # å¿«é€Ÿæ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–æ— äººæœºé‡å 
            for drone in self.placed_drones:
                px, py, pz = drone['position']
                pl, pw, ph = drone['size']

                if not (x + l <= px or px + pl <= x or
                        y + w <= py or py + pw <= y or
                        z + h <= pz or pz + ph <= z):
                    return False

            return True

        def find_best_position(self, drone_size):
            """å¿«é€Ÿå¯»æ‰¾æœ€ä½³æ”¾ç½®ä½ç½®"""
            l, w, h = drone_size

            # æŒ‰é«˜åº¦æ’åºï¼Œä¼˜å…ˆæ”¾åœ¨ä½å¤„
            self.available_positions.sort(key=lambda pos: (pos[2], pos[1], pos[0]))

            for position in self.available_positions[:100]:  # åªæ£€æŸ¥å‰100ä¸ªä½ç½®
                if self.can_place_drone(position, drone_size):
                    return position

            # å¦‚æœç°æœ‰ä½ç½®éƒ½ä¸è¡Œï¼Œå°è¯•åœ¨å·²æ”¾ç½®æ— äººæœºçš„å‘¨å›´ç”Ÿæˆæ–°ä½ç½®
            for drone in self.placed_drones[-50:]:  # åªæ£€æŸ¥æœ€è¿‘æ”¾ç½®çš„50ä¸ª
                px, py, pz = drone['position']
                pl, pw, ph = drone['size']

                # ç”Ÿæˆå€™é€‰ä½ç½®
                candidate_positions = [
                    (px + pl, py, pz),  # å³ä¾§
                    (px, py + pw, pz),  # å‰æ–¹
                    (px, py, pz + ph),  # ä¸Šæ–¹
                    (px + pl, py + pw, pz),  # å³å‰æ–¹
                    (px + pl, py, pz + ph),  # å³ä¸Šæ–¹
                    (px, py + pw, pz + ph)  # å‰ä¸Šæ–¹
                ]

                for pos in candidate_positions:
                    if pos not in self.available_positions and self.can_place_drone(pos, drone_size):
                        return pos

            return None

        def update_available_positions(self, new_drone_position, new_drone_size):
            """æ›´æ–°å¯ç”¨ä½ç½®åˆ—è¡¨"""
            x, y, z = new_drone_position
            l, w, h = new_drone_size

            # ç§»é™¤è¢«å ç”¨çš„ä½ç½®
            self.available_positions = [pos for pos in self.available_positions
                                        if not self.can_place_drone(pos, [1, 1, 1])]

            # æ·»åŠ æ–°çš„å€™é€‰ä½ç½®
            new_positions = [
                (x + l, y, z),  # å³ä¾§
                (x, y + w, z),  # å‰æ–¹
                (x, y, z + h),  # ä¸Šæ–¹
                (x + l, y + w, z),  # å³å‰æ–¹
                (x + l, y, z + h),  # å³ä¸Šæ–¹
                (x, y + w, z + h)  # å‰ä¸Šæ–¹
            ]

            for pos in new_positions:
                if (pos not in self.available_positions and
                        pos[0] <= self.container['size'][0] and
                        pos[1] <= self.container['size'][1] and
                        pos[2] <= self.container['size'][2]):
                    self.available_positions.append(pos)

        def pack_drones_fast(self):
            """å¿«é€Ÿè£…ç®±ç®—æ³•"""
            print("å¼€å§‹å¿«é€Ÿè£…ç®±...")

            # ç¬¬ä¸€é˜¶æ®µï¼šæ”¾ç½®å¤§çš„è½½é‡æ— äººæœº
            cargo_placed = 0
            max_cargo = 15

            while cargo_placed < max_cargo:
                position = self.find_best_position(self.drones['cargo']['size'])
                if position:
                    self.placed_drones.append({
                        'type': 'cargo',
                        'position': position,
                        'size': self.drones['cargo']['size'],
                        'color': self.drones['cargo']['color']
                    })
                    self.update_available_positions(position, self.drones['cargo']['size'])
                    cargo_placed += 1
                    print(f"æ”¾ç½®ç¬¬{cargo_placed}å°è½½é‡æ— äººæœº")
                else:
                    break

            # ç¬¬äºŒé˜¶æ®µï¼šæ”¾ç½®å°çš„ä¾¦å¯Ÿæ— äººæœºå¡«å……ç©ºéš™
            scout_placed = 0
            max_scout = 100

            while scout_placed < max_scout:
                position = self.find_best_position(self.drones['scout']['size'])
                if position:
                    self.placed_drones.append({
                        'type': 'scout',
                        'position': position,
                        'size': self.drones['scout']['size'],
                        'color': self.drones['scout']['color']
                    })
                    self.update_available_positions(position, self.drones['scout']['size'])
                    scout_placed += 1
                    if scout_placed % 20 == 0:
                        print(f"å·²æ”¾ç½®{scout_placed}å°ä¾¦å¯Ÿæ— äººæœº")
                else:
                    break

            print(f"è£…ç®±å®Œæˆï¼å…±æ”¾ç½® {len(self.placed_drones)} å°æ— äººæœº")

        def calculate_stats(self):
            """è®¡ç®—ç»Ÿè®¡ä¿¡æ¯"""
            total_volume = sum(d['size'][0] * d['size'][1] * d['size'][2]
                               for d in self.placed_drones)
            container_volume = (self.container['size'][0] *
                                self.container['size'][1] *
                                self.container['size'][2])

            scout_count = sum(1 for d in self.placed_drones if d['type'] == 'scout')
            cargo_count = sum(1 for d in self.placed_drones if d['type'] == 'cargo')

            return {
                'space_utilization': total_volume / container_volume,
                'total_drones': len(self.placed_drones),
                'scout_count': scout_count,
                'cargo_count': cargo_count,
                'total_volume': total_volume,
                'container_volume': container_volume
            }

        def draw_cube_wireframe(self, ax, position, size, color):
            """ç»˜åˆ¶ç«‹æ–¹ä½“çº¿æ¡†ï¼Œéšè—è¾¹ç”¨è™šçº¿"""
            x, y, z = position
            l, w, h = size

            # å®šä¹‰ç«‹æ–¹ä½“çš„8ä¸ªé¡¶ç‚¹
            vertices = np.array([
                [x, y, z],
                [x + l, y, z],
                [x + l, y + w, z],
                [x, y + w, z],
                [x, y, z + h],
                [x + l, y, z + h],
                [x + l, y + w, z + h],
                [x, y + w, z + h]
            ])

            # å®šä¹‰12æ¡è¾¹
            edges = [
                [0, 1], [1, 2], [2, 3], [3, 0],  # åº•é¢
                [4, 5], [5, 6], [6, 7], [7, 4],  # é¡¶é¢
                [0, 4], [1, 5], [2, 6], [3, 7]  # ä¾§é¢
            ]

            # ç»˜åˆ¶è¾¹
            for i, edge in enumerate(edges):
                # ç®€å•åˆ¤æ–­çº¿å‹
                if i < 4:  # åº•è¾¹ - å®çº¿
                    linestyle = '-'
                elif i < 8:  # é¡¶è¾¹ - è™šçº¿
                    linestyle = '--'
                else:  # ä¾§è¾¹ - æ ¹æ®ä½ç½®åˆ¤æ–­
                    v1 = vertices[edge[0]]
                    if (v1[0] == 0 or v1[0] == self.container['size'][0] or
                            v1[1] == 0 or v1[1] == self.container['size'][1]):
                        linestyle = '-'
                    else:
                        linestyle = '--'

                ax.plot3D([vertices[edge[0]][0], vertices[edge[1]][0]],
                          [vertices[edge[0]][1], vertices[edge[1]][1]],
                          [vertices[edge[0]][2], vertices[edge[1]][2]],
                          color=color, linewidth=1.2, linestyle=linestyle)

        def visualize_3d(self):
            """æ˜¾ç¤º3Dè£…ç®±æƒ…å†µï¼ˆä¿®å¤ä¸­æ–‡æ˜¾ç¤ºï¼‰"""
            # ========== ä¸­æ–‡æ˜¾ç¤ºé…ç½® ==========
            import matplotlib.pyplot as plt
            plt.rcParams["font.family"] = ["SimHei", "Arial Unicode MS", "WenQuanYi Micro Hei"]  # é€‚é…ä¸åŒç³»ç»Ÿçš„ä¸­æ–‡å­—ä½“
            plt.rcParams["axes.unicode_minus"] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºå¼‚å¸¸çš„é—®é¢˜
            # ==================================

            fig = plt.figure(figsize=(15, 10))
            ax = fig.add_subplot(111, projection='3d')

            # ç»˜åˆ¶é›†è£…ç®±çº¿æ¡†
            container = self.container['size']
            self.draw_cube_wireframe(ax, (0, 0, 0), container, 'blue')

            # ç»˜åˆ¶æ‰€æœ‰æ— äººæœºçº¿æ¡†
            for drone in self.placed_drones:
                self.draw_cube_wireframe(ax, drone['position'], drone['size'], drone['color'])

            # è®¾ç½®åæ ‡è½´ï¼ˆä¸­æ–‡æ ‡ç­¾ï¼‰
            ax.set_xlabel('é•¿åº¦ (mm)', fontsize=12)
            ax.set_ylabel('å®½åº¦ (mm)', fontsize=12)
            ax.set_zlabel('é«˜åº¦ (mm)', fontsize=12)
            ax.set_title('æ— äººæœºä¸‰ç»´è£…ç®±å¸ƒå±€', fontsize=14, fontweight='bold')

            # è®¾ç½®è§†è§’
            ax.view_init(elev=25, azim=45)

            # æ·»åŠ å›¾ä¾‹ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰
            from matplotlib.lines import Line2D
            legend_elements = [
                Line2D([0], [0], color='red', linewidth=2, label=f'è½½é‡æ— äººæœº ({self.drones["cargo"]["name"]})'),
                Line2D([0], [0], color='green', linewidth=2, label=f'ä¾¦å¯Ÿæ— äººæœº ({self.drones["scout"]["name"]})'),
                Line2D([0], [0], color='blue', linewidth=2, label='é›†è£…ç®±'),
                Line2D([0], [0], color='black', linewidth=2, linestyle='-', label='å®çº¿: å¯è§è¾¹'),
                Line2D([0], [0], color='black', linewidth=2, linestyle='--', label='è™šçº¿: éšè—è¾¹')
            ]
            ax.legend(handles=legend_elements, loc='upper left')

            # è®¾ç½®åæ ‡è½´èŒƒå›´
            ax.set_xlim(0, container[0])
            ax.set_ylim(0, container[1])
            ax.set_zlim(0, container[2])

            plt.tight_layout()
            plt.show()

        def print_results(self):
            """æ‰“å°ç»“æœ"""
            stats = self.calculate_stats()

            print("=" * 60)
            print("å¿«é€Ÿæ— äººæœºè£…ç®±ç»“æœ")
            print("=" * 60)
            print(f"ç©ºé—´åˆ©ç”¨ç‡: {stats['space_utilization']:.2%}")
            print(f"æ— äººæœºæ€»æ•°: {stats['total_drones']}")
            print(f"  - è½½é‡æ— äººæœº: {stats['cargo_count']}å°")
            print(f"  - ä¾¦å¯Ÿæ— äººæœº: {stats['scout_count']}å°")
            print(f"æ€»ä½“ç§¯: {stats['total_volume']:,.0f} mmÂ³")
            print(f"é›†è£…ç®±ä½“ç§¯: {stats['container_volume']:,.0f} mmÂ³")
            print(f"å¡«å……å¯†åº¦: {stats['total_drones'] / (stats['container_volume'] / 1e6):.1f} å°/ç«‹æ–¹ç±³")
            print("=" * 60)

        # è¿è¡Œå¿«é€Ÿè£…ç®±ç®—æ³•
        def __init__(self):
            # æ— äººæœºå‚æ•° (é•¿Ã—å®½Ã—é«˜ mm)
            self.drones = {
                'cargo': {'size': [1105, 1265, 975], 'color': 'red', 'name': 'FlyCart 100'},
                'scout': {'size': [221, 96.3, 90.3], 'color': 'green', 'name': 'Mavic 3E'}
            }

            # é›†è£…ç®±å‚æ•° (é•¿Ã—å®½Ã—é«˜ mm)
            self.container = {'size': [6058, 2591, 2438]}

            # å­˜å‚¨æ”¾ç½®çš„æ— äººæœº
            self.placed_drones = []

            # è®°å½•å¯ç”¨ä½ç½®
            self.available_positions = [(0, 0, 0)]
            # ç¾æƒ…ç±»å‹æ˜ å°„
            self.disaster_mapping = {
                'cargo': 'ç‰©èµ„æŠ•é€ç±»ç¾æƒ…ï¼ˆåœ°éœ‡ã€æ´ªæ°´ç­‰éœ€è¦å¤§é‡ç‰©èµ„é…é€ï¼‰',
                'scout': 'ä¾¦å¯Ÿç›‘æµ‹ç±»ç¾æƒ…ï¼ˆæ£®æ—ç«ç¾ã€åœ°è´¨ç¾å®³ç­‰éœ€è¦æŒç»­ç›‘æ§ï¼‰'
            }

            def __init__(self):
                pass

        def print_results(self):
            stats = self.calculate_stats()
            print("=" * 60)
            print("å¿«é€Ÿæ— äººæœºè£…ç®±ç»“æœ")
            print("=" * 60)
            print(f"ç©ºé—´åˆ©ç”¨ç‡: {stats['space_utilization']:.2%}")
            print(f"æ— äººæœºæ€»æ•°: {stats['total_drones']}")
            print(f"  - è½½é‡æ— äººæœº: {stats['cargo_count']}å° ({self.drones['cargo']['name']})")
            print(f"  - ä¾¦å¯Ÿæ— äººæœº: {stats['scout_count']}å° ({self.drones['scout']['name']})")
            print()
            print("ç¾æƒ…åº”ç”¨ç±»å‹:")
            if stats['cargo_count'] > 0:
                print(f"  - ç‰©èµ„æŠ•é€ç±»ç¾æƒ…: {stats['cargo_count']}å° {self.drones['cargo']['name']}")
                print("    é€‚ç”¨åœºæ™¯: åœ°éœ‡ã€æ´ªæ°´ç­‰éœ€è¦å¤§é‡ç‰©èµ„é…é€çš„ç¾å®³")
            if stats['scout_count'] > 0:
                print(f"  - ä¾¦å¯Ÿç›‘æµ‹ç±»ç¾æƒ…: {stats['scout_count']}å° {self.drones['scout']['name']}")
                print("    é€‚ç”¨åœºæ™¯: æ£®æ—ç«ç¾ã€åœ°è´¨ç¾å®³ç­‰éœ€è¦æŒç»­ç›‘æ§çš„ç¾å®³")
            print()
            print(f"æ€»ä½“ç§¯: {stats['total_volume']:,.0f} mmÂ³")
            print(f"é›†è£…ç®±ä½“ç§¯: {stats['container_volume']:,.0f} mmÂ³")
            print(f"å¡«å……å¯†åº¦: {stats['total_drones'] / (stats['container_volume'] / 1e6):.1f} å°/ç«‹æ–¹ç±³")
            print("=" * 60)

    if __name__ == "__main__":
        # Create packer instance
        packer = FastDronePacking()

        # Run packing algorithm
        packer.pack_drones_fast()

        # Print results
        packer.print_results()

        # Visualize in 3D
        packer.visualize_3d()

    def run_streamlit(self):
        """Streamlitä¸“ç”¨è¿è¡Œæ–¹æ³•"""
        # é¡µé¢é…ç½®
        st.set_page_config(
            page_title="æ— äººæœºè£…ç®±æ¨¡æ‹Ÿå™¨",
            page_icon="ğŸš",
            layout="wide",
            initial_sidebar_state="expanded"
        )

        # ä¾§è¾¹æ å‚æ•°è®¾ç½®
        st.sidebar.header("è£…ç®±å‚æ•°è®¾ç½®")
        cargo_num = st.sidebar.number_input("è½½é‡æ— äººæœºæ•°é‡", 0, 15, 5)
        scout_num = st.sidebar.number_input("ä¾¦å¯Ÿæ— äººæœºæ•°é‡", 0, 100, 20)

        # æ§åˆ¶æŒ‰é’®
        if st.sidebar.button("å¼€å§‹æ¨¡æ‹Ÿ"):
            with st.spinner("æ­£åœ¨è®¡ç®—è£…ç®±æ–¹æ¡ˆ..."):
                self.pack_drones_fast(cargo_num, scout_num)
                st.success("è£…ç®±å®Œæˆï¼")

        # ç»“æœå±•ç¤º
        if hasattr(self, 'placed_drones'):
            st.header("è£…ç®±ç»“æœ")
            self.show_statistics()
            self.visualize_3d()

    def show_statistics(self):
        """å±•ç¤ºç»Ÿè®¡ä¿¡æ¯"""
        stats = self.calculate_stats()
        col1, col2 = st.columns(2)

        with col1:
            st.metric("ç©ºé—´åˆ©ç”¨ç‡", f"{stats['space_utilization']:.2%}")
            st.metric("æ€»æ— äººæœºæ•°", f"{stats['total_drones']}å°")
            st.metric("å¡«å……å¯†åº¦", f"{stats['total_drones'] / (stats['container_volume'] / 1e6):.1f} å°/ç«‹æ–¹ç±³")

        with col2:
            disaster_type = "ç‰©èµ„æŠ•é€ç±»" if stats['cargo_count'] > 0 else "ä¾¦å¯Ÿç›‘æµ‹ç±»"
            st.metric("ä¸»è¦ç¾æƒ…ç±»å‹", disaster_type)
            st.metric("é›†è£…ç®±ä½“ç§¯", f"{stats['container_volume']:,} mmÂ³")

    def visualize_3d(self):
        """Streamlitä¸“ç”¨3Då¯è§†åŒ–"""
        container_size = self.container['size']
        fig = plt.figure(figsize=(12, 8))
        ax = fig.add_subplot(111, projection='3d')

        # ç»˜åˆ¶é›†è£…ç®±
        self.draw_cube_wireframe(ax, (0, 0, 0), container_size, 'blue')

        # ç»˜åˆ¶æ— äººæœº
        for drone in self.placed_drones:
            self.draw_cube_wireframe(
                ax, drone['position'], drone['size'], drone['color']
            )

        # é…ç½®ä¸­æ–‡æ˜¾ç¤º
        plt.rcParams["font.family"] = ["Microsoft YaHei", "SimHei", "Arial Unicode MS"]
        plt.rcParams["axes.unicode_minus"] = False

        # è®¾ç½®åæ ‡è½´
        ax.set_xlabel('é•¿åº¦ (mm)', fontsize=12)
        ax.set_ylabel('å®½åº¦ (mm)', fontsize=12)
        ax.set_zlabel('é«˜åº¦ (mm)', fontsize=12)
        ax.set_title('æ— äººæœºä¸‰ç»´è£…ç®±å¸ƒå±€', fontsize=14, pad=20)

        # ä¼˜åŒ–è§†è§’
        ax.view_init(elev=20, azim=30)
        ax.dist = 10

        # æ¸…é™¤åæ ‡è½´åˆ»åº¦
        ax.set_xticks([])
        ax.set_yticks([])
        ax.set_zticks([])

        # è½¬æ¢ä¸ºbase64å›¾ç‰‡
        buf = BytesIO()
        plt.savefig(buf, format='png', bbox_inches='tight', pad_inches=0.1)
        buf.seek(0)
        st.pyplot(fig, clear_figure=False)
        plt.close(fig)

    def draw_cube_wireframe(self, ax, position, size, color):
        """ä¼˜åŒ–åçš„3Dç»˜åˆ¶æ–¹æ³•"""
        x, y, z = position
        l, w, h = size

        # å®šä¹‰é¡¶ç‚¹
        verts = [
            [x, y, z], [x + l, y, z], [x + l, y + w, z], [x, y + w, z],
            [x, y, z + h], [x + l, y, z + h], [x + l, y + w, z + h], [x, y + w, z + h]
        ]

        # å®šä¹‰è¾¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        edges = [
            (0, 1, 0, 0, 0, 0), (1, 2, 0, 0, 0, 0), (2, 3, 0, 0, 0, 0), (3, 0, 0, 0, 0, 0),
            (4, 5, 0, 0, 0, 1), (5, 6, 0, 0, 0, 1), (6, 7, 0, 0, 0, 1), (7, 4, 0, 0, 0, 1),
            (0, 4, 0, 0, 1, 0), (1, 5, 0, 0, 1, 0), (2, 6, 0, 0, 1, 0), (3, 7, 0, 0, 1, 0)
        ]

        # ç»˜åˆ¶è¾¹çº¿
        for edge in edges:
            v1 = verts[edge[0]]
            v2 = verts[edge[1]]
            color = edge[5] if len(edge) > 5 else 'red' if 'cargo' in self.placed_drones[edge[0]]['type'] else 'green'
            ax.plot3D(
                [v1[0], v2[0]], [v1[1], v2[1]], [v1[2], v2[2]],
                color=color, linewidth=1.5, linestyle='-' if edge[5] == 0 else '--'
            )


if __name__ == "__main__":
    # åˆå§‹åŒ–åº”ç”¨
    app = FastDronePacking()

    # è¿è¡ŒStreamlitåº”ç”¨
    app.run_streamlit()
